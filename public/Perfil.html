<!DOCTYPE html>
<html lang="en">

<head>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                const response = await fetch('/api/auth/verificarJWT', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                if (!response.ok) {
                    window.location.href = '/Login.html';
                }
            } catch (error) {
                console.error('Error al verificar el JWT:', error);
                window.location.href = '/Login.html';
            }
        });
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="assets/LogoImg.png">
    <link rel="stylesheet" href="styles/general.css">
    <link rel="stylesheet" href="styles/perfil.css">
    <title>ProSys - Perfil</title>
</head>

<body>
    <!--  BARRA DE NAVEGACIÓN  -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="navbar-logo">
                <img class="navbar-image" src="assets/LogoHorizontal.png" alt="">
            </a>
            <ul class="navbar-menu">
                <li class="navbar-item">
                    <a href="index.html" class="navbar-link">Inicio</a>
                </li>
                <li class="navbar-item">
                    <a href="Documentos.html" class="navbar-link">Documentos</a>
                </li>
                <li class="navbar-item">
                    <a href="Perfil.html" class="navbar-link">Perfil</a>
                </li>
                <li class="navbar-item">
                    <a href="Login.html" class="navbar-link">Inicio de sesión</a>
                </li>
                <li class="navbar-item">
                    <a href="RegistroProtocolo.html" class="navbar-link">Registro Protocolo</a>
                </li>
                <li class="navbar-item">
                    <a href="javascript:void(0);" class="btn-cerrar-sesion" onclick="cerrarSesion()">Cerrar sesión</a>
                </li>
            </ul>
        </div>
    </nav>
    <!--    -->
    <!--  PÁGINA   -->
    <div class="perfil-container">
        <div class="perfil-sidebar">
            <img src="assets/FotoPerfil.jpg" alt="Foto de perfil" class="perfil-img" />
            <h2 id="usuario-nombre">Nombre del Estudiante</h2>
            <p id="usuario-boleta">Número de Boleta: 12345678</p>
            <p id="usuario-correo">Correo: estudiante@correo.com</p>
            <a href="EditarUsuario.html" class="btn-editar">Editar Perfil</a>
        </div>
        <div class="perfil-main-content">
            <div class="perfil-grid-section">
                <h3>Tus Protocolos</h3>
                <div class="perfil-grid">
                    
                </div>
            </div>
        </div>
    </div>

    <!--  SCRIPT DE CONSULTA  -->
    <script>
        // Obtener Usuario
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                const response = await fetch('/api/usuarios/me', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: "include"
                });
                const data = await response.json();
                console.log(data);
                if (response.ok) {
                    console.log('Usuario:', data);
                    // // Actualizar datos de usuario en la interfaz de usuario
                    document.getElementById('usuario-nombre').innerText = data.nombre;
                    document.getElementById('usuario-correo').innerText = `Correo: ${data.correo}`;
                    if(data.boleta){
                        document.getElementById('usuario-boleta').innerText = `Boleta: ${data.boleta}`;
                    }
                    if(data.cedula){
                        document.getElementById('usuario-boleta').innerText = `Boleta: ${data.cedula}`;
                    }
                }
                if (response.ok === false) {
                    console.log('Respuesta del servidor:', data.msg);
                }
            } catch (error) {
                console.error('Error en la petición:', error);
                alert('Hubo un error al intentar obtener el usuario.');
            }
        });
        // Obtener Protocolos
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                const protocolosContainer = document.querySelector('.perfil-grid');
                // Realizar la petición al backend para obtener el saldo
                const response = await fetch('/api/protocolos/me', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: "include"
                });
                const data = await response.json();
                if (response.ok) {
                    console.log('Respuesta del servidor:', data); // Verifica que los datos lleguen correctamente

                    const protocolosContainer = document.querySelector('.perfil-grid');
                    const protocoloLink = document.createElement('a');
                    protocoloLink.href = "Protocolo.html";
                    protocoloLink.className = "perfil-card";

                    // Acceso directo al objeto
                    const nombre = data?.protocolo?.nombre ?? "Sin nombre";
                    const lider = data?.protocolo?.lider?.nombre ?? "Líder no asignado";
                    const descripcion = data?.protocolo?.descripcion ?? "Sin descripción disponible";
                    const estado = data?.protocolo?.estado ?? "Estado no definido";

                    // Leer los integrantes
                    let integrantesHTML = '';
                    if (Array.isArray(data.protocolo.integrantes) && data.protocolo.integrantes.length > 0) {
                        integrantesHTML = '<h5>Integrantes:</h5>';
                        data.protocolo.integrantes.forEach((integrante, index) => {
                            integrantesHTML += `<p>Integrante ${index + 1}: ${integrante?.nombre || "Nombre no disponible"}</p>`;
                        });
                    } else {
                        integrantesHTML = '<p>No hay integrantes asignados</p>';
                    }

                    // Leer los directores
                    let directoresHTML = '';
                    if (Array.isArray(data.protocolo.directores) && data.protocolo.directores.length > 0) {
                        directoresHTML = '<h5>Directores:</h5>';
                        data.protocolo.directores.forEach((director, index) => {
                            directoresHTML += `<p>Director ${index + 1}: ${director?.nombre || "Nombre no disponible"}</p>`;
                        });
                    } else {
                        directoresHTML = '<p>No hay directores asignados</p>';
                    }

                    // Leer los sinodales
                    let sinodalesHTML = '';
                    if (Array.isArray(data.sinodales) && data.sinodales.length > 0) {
                        sinodalesHTML = '<h5>Sinodales:</h5>';
                        data.sinodales.forEach((sinodal, index) => {
                            sinodalesHTML += `<p>Sinodal ${index + 1}: ${sinodal?.nombre || "Nombre no disponible"}</p>`;
                        });
                    } else {
                        sinodalesHTML = '<p>No hay sinodales asignados</p>';
                    }

                    // Crear el HTML final
                    protocoloLink.innerHTML = `
                        <h4>Nombre del protocolo:<br>${nombre}</h4>
                        <hr>
                        <p><strong>Líder:</strong> ${lider}</p>
                        <hr>
                        ${integrantesHTML}
                        <hr>
                        ${directoresHTML}
                        <hr>
                        ${sinodalesHTML}
                        <hr>
                        <p><strong>Descripción:</strong> ${descripcion}</p>
                        <hr>
                        <p><strong>Estado:</strong> ${estado}</p>
                    `;

                    protocolosContainer.appendChild(protocoloLink);
                    
                } else {
                    console.log('Respuesta del servidor:', data);
                    const protocolosContainer = document.querySelector('.perfil-grid-section');
                    const protocoloDiv = document.createElement('div');
                    protocoloDiv.classList.add('noprotocolos');
                    protocoloDiv.innerHTML = `
                    <h4>Aún no tienes protocolos</h4>
                    `;
                    protocolosContainer.appendChild(protocoloDiv);
                    console.error('Error en la petición:', error);
                    alert('Hubo un error al intentar obtener los protocolos.');
                }

            } catch (error) {
                console.error('Error en la petición:', error);
            }
        });
        //Cerrar sesion
        async function cerrarSesion() {
        try {
            const response = await fetch('/api/auth/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
            });
            const data = await response;
            console.log(data);
            // Verifica si la respuesta es exitosa
            if (response.ok) {
                // Redirige al usuario a la página de login
                window.location.href = '/Login.html';
            } else {
                const data = await response.json(); // Obtener la respuesta del servidor
                console.log('Respuesta del servidor:', data); // Verifica la respuesta
            }
        } catch (error) {
            console.error('Error en la solicitud de cierre de sesión:', error);
        }
    }


    </script>

    <!--  FOOTER  -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-logo">
                <img src="assets/LogoPrincipal.png" alt="Logo" class="footer-logo-img">
            </div>
            <div class="footer-aside">
                <p class="footer-text">
                    Todos los derechos reservados.
                </p>
                <ul class="footer-menu">
                    <li class="footer-item">
                        <a href="/politica" class="footer-link">Política de Privacidad</a>
                    </li>
                    <li class="footer-item">
                        <a href="/terminos" class="footer-link">Términos y Condiciones</a>
                    </li>
                    <li class="footer-item">
                        <a href="/contacto" class="footer-link">Contacto</a>
                    </li>
                </ul>
            </div>
        </div>
    </footer>
    <!--    -->

</body>

</html>